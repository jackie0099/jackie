<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetFlow v7.5 - Group Color Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --primary: #dc2626; --card: #ffffff; --text-dark: #1e293b; --whatsapp: #25D366; }
        body { font-family: 'Noto Sans Lao', sans-serif; background: var(--bg); color: #f8fafc; margin: 0; padding: 15px; padding-bottom: 120px; }
        .container { max-width: 900px; margin: auto; }
        .panel { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 15px; color: var(--text-dark); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        textarea, input { width: 100%; padding: 12px; border: 1.5px solid #cbd5e1; border-radius: 10px; margin-bottom: 8px; box-sizing: border-box; font-family: inherit; }
        .btn { border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; font-family: inherit; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; width: 100%; }
        .btn-sync { background: #0ea5e9; color: white; width: 100%; margin-bottom: 10px; }
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
        .car-card { background: var(--card); color: var(--text-dark); padding: 15px; border-radius: 12px; border-left: 8px solid #94a3b8; cursor: pointer; transition: 0.2s; position: relative; }
        .car-card.selected { border-left-color: #000; background-color: #f1f5f9; transform: scale(1.02); }
        .status-badge { font-size: 11px; font-weight: bold; float: right; padding: 3px 8px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.1); }
        .plate { font-size: 1.3rem; font-weight: 700; color: #000; display: block; }
        .edit-box { display: none; margin-top: 10px; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        #waBtn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; background: var(--whatsapp); color: white; font-size: 18px; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:9999; flex-direction: column; }
    </style>
</head>
<body>

<div id="loader" class="loading">‚è≥ <p>‡∫Å‡∫≥‡∫•‡∫±‡∫á Sync ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô Cloud...</p></div>

<div class="container">
    <h2 style="text-align:center;">üöÄ ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫î v7.5</h2>
    <button class="btn btn-sync" onclick="fetchCloudData()">üîÑ Sync ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô (‡∫Ñ‡∫≠‡∫° & ‡∫°‡∫∑‡∫ñ‡∫∑)</button>

    <div class="panel">
        <textarea id="rawText" rows="3" placeholder="‡∫ß‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫°‡∫ó‡∫ª‡∫ß..." oninput="autoParse()"></textarea>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="text" id="tourID" placeholder="‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ó‡∫ª‡∫ß">
            <input type="number" id="carQty" placeholder="‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫•‡∫ª‡∫î">
        </div>
        <input type="datetime-local" id="endTime">
        <input type="text" id="tourDetail" placeholder="‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫ó‡∫ª‡∫ß">
        <button class="btn btn-main" onclick="autoMatch()">üé≤ ‡∫™‡∫∏‡ªà‡∫°‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î</button>
        <button class="btn" style="background:#64748b; color:white; width:100%; margin-top:5px;" onclick="resetAll()">üîÑ ‡∫•‡∫µ‡ªÄ‡∫ä‡∫±‡∫î‡∫•‡∫ª‡∫î‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</button>
    </div>

    <div id="fleetDisplay" class="fleet-grid"></div>
    <button id="waBtn" class="btn" onclick="saveAndSend()">üöÄ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å & ‡∫™‡∫ª‡ªà‡∫á WhatsApp</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxjLwcmVBOGc2_VPYkiKrdKCQhTu9AbVc1vvWmH7b_MR-159N0s6YXS5ifMcDDL587W/exec";

    let cars = [];
    let selectedPlates = [];

    async function fetchCloudData() {
        document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            const now = new Date().getTime();
            
            cars = data.map(c => ({
                ...c,
                isBusy: c.endTime && now < new Date(c.endTime).getTime()
            }));
            render();
        } catch (e) { alert("‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà Cloud ‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ!"); }
        document.getElementById('loader').style.display = 'none';
    }

    function render() {
        const grid = document.getElementById('fleetDisplay');
        grid.innerHTML = '';
        cars.forEach(car => {
            const isSel = selectedPlates.includes(car.plate);
            // ‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö‡∫™‡∫µ‡∫Å‡∫∏‡ªà‡∫°: ‡∫ñ‡ªâ‡∫≤‡∫ï‡∫¥‡∫î‡∫ß‡∫Ω‡∫Å ‡ªÉ‡∫´‡ªâ‡ªÉ‡∫ä‡ªâ‡∫™‡∫µ‡∫ó‡∫µ‡ªà‡∫°‡∫≤‡∫à‡∫≤‡∫Å Cloud, ‡∫ñ‡ªâ‡∫≤‡∫ß‡ªà‡∫≤‡∫á‡ªÉ‡∫´‡ªâ‡ªÄ‡∫õ‡∫±‡∫ô‡∫™‡∫µ‡∫Ç‡∫Ω‡∫ß
            const cardColor = car.isBusy ? (car.groupColor || '#fee2e2') : '#ffffff';
            const borderColor = car.isBusy ? 'red' : (isSel ? 'black' : '#94a3b8');

            grid.innerHTML += `
                <div class="car-card ${isSel ? 'selected' : ''}" 
                     style="background-color: ${cardColor}; border-left-color: ${borderColor};">
                    <span class="status-badge" style="background:${car.isBusy ? '#fff' : '#dcfce7'}">
                        ${car.isBusy ? 'üî¥ ' + car.tourName : 'üü¢ ‡∫ß‡ªà‡∫≤‡∫á'}
                    </span>
                    <span class="plate" onclick="toggleCar('${car.plate}', ${car.isBusy})">${car.plate}</span>
                    <div style="font-weight:bold;">üë§ ${car.driver}</div>
                    <div style="font-size:12px; color:#64748b;">üìû ${car.phone}</div>
                    <button class="btn" style="padding:2px 10px; font-size:11px; margin-top:5px;" onclick="showEdit('${car.plate}')">‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç</button>
                    
                    <div id="edit-${car.plate}" class="edit-box">
                        <input type="text" id="d-${car.plate}" value="${car.driver}">
                        <input type="text" id="p-${car.plate}" value="${car.phone}">
                        <button class="btn btn-main" style="padding:5px;" onclick="saveCar('${car.plate}')">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</button>
                    </div>
                </div>`;
        });
    }

    function toggleCar(plate, isBusy) {
        if(isBusy) return;
        const idx = selectedPlates.indexOf(plate);
        if(idx > -1) selectedPlates.splice(idx, 1);
        else selectedPlates.push(plate);
        render();
    }

    function autoParse() {
        const text = document.getElementById('rawText').value;
        const idMatch = text.match(/(ID|‡∫•‡∫∞‡∫´‡∫±‡∫î):\s*(\w+)/i);
        if(idMatch) document.getElementById('tourID').value = idMatch[2];
        const qtyMatch = text.match(/(\d+)\s*‡∫Ñ‡∫±‡∫ô/);
        if(qtyMatch) document.getElementById('carQty').value = qtyMatch[1];
    }

    function autoMatch() {
        const qty = parseInt(document.getElementById('carQty').value) || 0;
        selectedPlates = cars.filter(c => !c.isBusy).sort(() => 0.5 - Math.random()).slice(0, qty).map(c => c.plate);
        render();
    }

    async function saveAndSend() {
        const tid = document.getElementById('tourID').value;
        const end = document.getElementById('endTime').value;
        if(!tid || selectedPlates.length === 0) return alert("‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î!");

        document.getElementById('loader').style.display = 'flex';
        const selCars = selectedPlates.map(p => cars.find(c => c.plate === p));
        
        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ tourName: tid, endTime: end, selectedCars: selCars })
            });

            const msg = `üöõ *‡ªÅ‡∫à‡ªâ‡∫á‡∫ó‡∫ª‡∫ß: ${tid}*\n‚åõ *‡∫™‡∫ª‡ªà‡∫á‡∫•‡∫ª‡∫î:* ${end}\n----------\n` + 
                        selCars.map((c, i) => `${i+1}. ‚úÖ *${c.plate}* (${c.driver})`).join('\n');
            window.location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            selectedPlates = [];
            setTimeout(fetchCloudData, 2000);
        } catch (e) { alert("‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î!"); }
        document.getElementById('loader').style.display = 'none';
    }

    function showEdit(p) { const el = document.getElementById(`edit-${p}`); el.style.display = el.style.display==='block'?'none':'block'; }
    
    async function saveCar(p) {
        const d = document.getElementById(`d-${p}`).value;
        const ph = document.getElementById(`p-${p}`).value;
        // ‡∫™‡∫ª‡ªà‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÑ‡∫õ‡∫≠‡∫±‡∫ö‡ªÄ‡∫î‡∫î‡∫ä‡∫∑‡ªà‡ªÉ‡∫ô Google Sheets (‡∫ï‡ªâ‡∫≠‡∫á‡∫°‡∫µ function update ‡ªÉ‡∫ô Apps Script)
        alert("‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô " + p + " ‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î (Sync ‡ªÉ‡∫ô‡∫Æ‡∫≠‡∫ö‡∫ñ‡∫±‡∫î‡ªÑ‡∫õ)");
        showEdit(p);
    }

    async function resetAll() {
        if(confirm("‡∫•‡∫µ‡ªÄ‡∫ä‡∫±‡∫î‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫±‡∫ô?")) {
            await fetch(API_URL + "?action=reset", { method: 'POST', mode: 'no-cors' });
            setTimeout(fetchCloudData, 1000);
        }
    }

    window.onload = fetchCloudData;
</script>
</body>
</html>
