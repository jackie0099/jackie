<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fleet Master Cloud Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e11d48; --accent: #0ea5e9; --bg: #0f172a; }
        body { font-family: 'Noto Sans Lao', sans-serif; background: var(--bg); color: white; margin: 0; padding: 15px; }
        .panel { background: white; color: #1e293b; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 10px; font-family: inherit; }
        .btn { border: none; padding: 15px; border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; font-family: inherit; }
        .btn-main { background: var(--primary); color: white; }
        .car-card { background: white; color: #333; padding: 15px; border-radius: 12px; border-left: 8px solid #22c55e; margin-bottom: 10px; }
        .car-card.busy { border-left-color: #e11d48; background: #fff1f2; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="loader">üîÑ ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà Cloud...</div>

<header style="display:flex; justify-content:space-between; margin-bottom:20px;">
    <b>üöõ Fleet Master Cloud</b>
    <button onclick="syncData()" style="color:var(--accent); background:none; border:none; cursor:pointer;">üîÑ Refresh</button>
</header>

<div class="panel">
    <h3 style="margin-top:0; color:#333;">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫•‡∫ª‡∫î‡ªÉ‡ªù‡ªà</h3>
    <input type="text" id="newP" placeholder="‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡∫•‡∫ª‡∫î">
    <input type="text" id="newD" placeholder="‡∫ä‡∫∑‡ªà‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö">
    <input type="text" id="newPh" placeholder="‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó">
    <button class="btn btn-main" onclick="addCar()">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫ª‡∫á Google Sheet</button>
</div>

<div id="fleet"></div>

<script>
    // ‚ö†Ô∏è ‡∫ô‡∫≥ URL ‡ªÉ‡ªù‡ªà‡∫ó‡∫µ‡ªà‡ªÑ‡∫î‡ªâ‡∫à‡∫≤‡∫Å‡∫Å‡∫≤‡∫ô Deploy ‡ªÄ‡∫õ‡∫±‡∫ô "Anyone" ‡∫°‡∫≤‡∫õ‡ªà‡∫Ω‡∫ô‡∫ö‡ªà‡∫≠‡∫ô‡∫ô‡∫µ‡ªâ!
    const API_URL = "https://script.google.com/macros/s/AKfycbx_G-1Kcvk6nQM6mFobzsLV_p_MATCKXKLVUa4Gg7jMfYa-FH2ugHmCZW8Qh17eK1w/exec";

    async function syncData() {
        document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            const container = document.getElementById('fleet');
            container.innerHTML = data.fleet.length === 0 ? '<p style="text-align:center;">--- ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫ª‡∫î ---</p>' : '';
            
            data.fleet.forEach(car => {
                const active = data.tours.find(t => t.plate === car.plate && t.status === "Active");
                const card = document.createElement('div');
                card.className = `car-card ${active ? 'busy' : ''}`;
                card.innerHTML = `
                    <div style="font-size:10px; float:right; color:${active ? 'red' : 'green'}; font-weight:bold;">
                        ${active ? 'üî¥ ‡∫ö‡ªç‡ªà‡∫´‡∫ß‡ªà‡∫≤‡∫á' : 'üü¢ ‡∫´‡∫ß‡ªà‡∫≤‡∫á'}
                    </div>
                    <b>${car.plate}</b><br><small>üë§ ${car.driver}</small>
                    ${active ? `<br><button onclick="forceReset('${car.plate}')" style="color:red; background:none; border:none; cursor:pointer; font-size:11px;">üîÑ Reset</button>` : ''}
                `;
                container.appendChild(card);
            });
        } catch (e) { alert("‚ùå ‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà‡∫ö‡ªç‡ªà‡ªÑ‡∫î‡ªâ: ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö Deployment URL ‡ªÅ‡∫•‡∫∞ ‡∫ï‡∫±‡ªâ‡∫á‡ªÄ‡∫õ‡∫±‡∫ô Anyone"); }
        document.getElementById('loader').style.display = 'none';
    }

    async function addCar() {
        const p = document.getElementById('newP').value;
        const d = document.getElementById('newD').value;
        const ph = document.getElementById('newPh').value;
        if(!p || !d) return alert("‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö!");

        document.getElementById('loader').style.display = 'flex';
        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: "ADD_CAR", plate: p, driver: d, phone: ph })
            });
            setTimeout(() => { 
                document.getElementById('newP').value=''; 
                document.getElementById('newD').value=''; 
                syncData(); 
            }, 2500);
        } catch (e) { alert("Error: " + e); }
    }

    async function forceReset(p) {
        if(!confirm(`Reset ‡∫•‡∫ª‡∫î ${p}?`)) return;
        document.getElementById('loader').style.display = 'flex';
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "RESET_SINGLE", plate: p }) });
        setTimeout(syncData, 2000);
    }

    window.onload = syncData;
</script>
</body>
</html>
