<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fleet Master Pro v24.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --accent: #0ea5e9;
            --success: #22c55e;
            --danger: #ef4444;
            --bg: #0f172a;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --radius: 16px;
        }

        body {
            font-family: 'Noto Sans Lao', sans-serif;
            background: var(--bg);
            background-image: radial-gradient(circle at 0% 0%, rgba(37, 99, 235, 0.1) 0%, transparent 40%);
            color: #fff; margin: 0; padding: 0; min-height: 100vh;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 15px; padding-bottom: 120px; }

        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px);
            border-radius: var(--radius); border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .panel {
            background: var(--card-bg); color: var(--text-main); padding: 20px;
            border-radius: var(--radius); margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
        }

        .grid-inputs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px; }
        
        input, textarea {
            width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px;
            font-family: inherit; font-size: 14px; box-sizing: border-box; transition: 0.2s;
        }

        input:focus { outline: none; border-color: var(--accent); }

        .btn {
            border: none; padding: 12px; border-radius: 10px; font-weight: 700;
            cursor: pointer; font-family: inherit; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .btn-fifo { background: var(--primary); color: white; width: 100%; margin-top: 10px; }
        .btn-admin { background: transparent; border: 1px solid white; color: white; font-size: 12px; padding: 6px 12px; }

        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }

        .car-card {
            background: white; color: var(--text-main); padding: 15px;
            border-radius: var(--radius); border-left: 8px solid #cbd5e1;
            transition: 0.3s; position: relative; cursor: pointer;
        }

        .car-card.selected { border-left-width: 15px; transform: scale(1.03); box-shadow: 0 0 15px rgba(14, 165, 233, 0.4); }
        .car-card.busy { opacity: 0.7; background: #f8fafc; cursor: not-allowed; }

        .plate-no { font-size: 1.5rem; font-weight: 800; color: #0f172a; line-height: 1; margin-bottom: 5px; }
        .badge { position: absolute; top: 10px; right: 10px; font-size: 10px; font-weight: 800; padding: 3px 8px; border-radius: 20px; color: white; text-transform: uppercase; }

        #waBtn {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; background: #25d366; color: white;
            z-index: 1000; box-shadow: 0 10px 25px rgba(37, 211, 102, 0.4); font-size: 1.1rem; padding: 18px;
        }

        @media (max-width: 500px) { .grid-inputs { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div style="font-size:1.3rem; font-weight:700;">üöõ Fleet Master <span style="color:var(--accent)">v24.2</span></div>
        <button class="btn btn-admin" onclick="toggleAdmin()">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏ñ</button>
    </header>

    <div id="admin" class="panel" style="display:none; background: #f1f5f9;">
        <h3 style="margin-top:0">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</h3>
        <div class="grid-inputs">
            <input type="text" id="newP" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏Å 1234)">
            <input type="text" id="newD" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö">
            <input type="text" id="newPh" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
        </div>
        <button class="btn btn-fifo" onclick="saveCarToSheet()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ</button>
    </div>

    <div class="panel">
        <label style="font-size:12px; font-weight:700; color:#64748b;">üìã ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å WHATSAPP</label>
        <textarea id="rawWA" rows="3" placeholder="‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥..." oninput="autoParse()"></textarea>

        <div class="grid-inputs" style="margin-top:15px;">
            <div><label style="font-size:11px">üÜî ‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏±‡∏ß‡∏£‡πå</label><input type="text" id="tourID" oninput="render()"></div>
            <div><label style="font-size:11px">üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ</label><input type="number" id="qty" placeholder="‡∏Å‡∏µ‡πà‡∏Ñ‡∏±‡∏ô?"></div>
        </div>
        
        <div class="grid-inputs">
            <div><label style="font-size:11px">üìÖ ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö</label><input type="datetime-local" id="startT"></div>
            <div><label style="font-size:11px">üèÅ ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á</label><input type="datetime-local" id="endT"></div>
        </div>

        <div style="margin-top:5px;">
            <label style="font-size:11px">üìç ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô</label>
            <input type="text" id="detail">
        </div>
        
        <button class="btn btn-fifo" onclick="fifoMatch()">‚öñÔ∏è ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏ñ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏≤‡∏ô‡∏™‡∏∏‡∏î)</button>
    </div>

    <div id="fleet" class="fleet-grid">
        </div>

    <button id="waBtn" class="btn" onclick="submitTour()">üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏™‡πà‡∏á WhatsApp</button>
</div>

<script>
    // --- API CONFIGURATION ---
    const API = "https://script.google.com/macros/s/AKfycbzk6LMDIHTZldp7m8Nis0jTxrQL_uc1-TeM_4GdIKXPI6IMUVTmEldQUx36cdk-XfU/exec";
    
    let fleet = [];
    let tourHistory = [];
    let selectedPlates = [];
    const VIBRANT_COLORS = ["#2563eb", "#d97706", "#7c3aed", "#db2777", "#059669", "#dc2626", "#0ea5e9"];

    // 1. Initial Data Sync
    async function syncData() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            fleet = data.fleet;
            tourHistory = data.activeStatus;
            render();
        } catch (e) { console.error("Sync Error:", e); }
    }

    // 2. Render Fleet UI
    function render() {
        const container = document.getElementById('fleet');
        container.innerHTML = '';
        const currentTid = document.getElementById('tourID').value || "SEL";

        fleet.forEach(car => {
            const lastJob = tourHistory.filter(t => t.plate === car.plate).pop();
            const isBusy = lastJob && lastJob.status === "Busy";
            const isSelected = selectedPlates.includes(car.plate);
            
            let color = "#cbd5e1";
            if(isBusy) color = getTourColor(lastJob.tourName);
            else if(isSelected) color = getTourColor(currentTid);

            const card = document.createElement('div');
            card.className = `car-card ${isBusy ? 'busy' : ''} ${isSelected ? 'selected' : ''}`;
            card.style.borderLeftColor = color;
            if(isSelected) card.style.backgroundColor = color + '10';

            card.innerHTML = `
                <div class="badge" style="background:${color}">${isBusy ? lastJob.tourName : (isSelected ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ß‡πà‡∏≤‡∏á')}</div>
                <div class="plate-no">${car.plate}</div>
                <div style="font-weight:600; font-size:14px;">üë§ ${car.driver}</div>
                <div style="font-size:12px; color:#64748b;">üìû ${car.phone}</div>
                ${isBusy ? `<button onclick="event.stopPropagation(); resetCar('${car.plate}')" style="margin-top:10px; width:100%; border:none; background:#fee2e2; color:#b91c1c; padding:4px; border-radius:5px; font-size:10px; font-weight:bold; cursor:pointer;">üîÑ Reset ‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á</button>` : ''}
            `;
            
            if(!isBusy) card.onclick = () => toggleSelect(car.plate);
            container.appendChild(card);
        });
    }

    // 3. WhatsApp Auto-Parser
    function autoParse() {
        const text = document.getElementById('rawWA').value;
        
        const idMatch = text.match(/([0-9]{4}[A-Z])/i);
        if(idMatch) document.getElementById('tourID').value = idMatch[0];

        const carMatch = text.match(/(\d+)\s*(‡∫Ñ‡∫±‡∫ô|‡∏Ñ‡∏±‡∏ô|‡∏£‡∏ñ)/);
        if(carMatch) document.getElementById('qty').value = carMatch[1];

        const paxMatch = text.match(/(\d+)\s*(‡∫Ñ‡∫ª‡∫ô|‡∏Ñ‡∏ô|pax)/);
        if(paxMatch) document.getElementById('detail').value = "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô " + paxMatch[0] + " ‡∏Ñ‡∏ô";

        // Date Picker Sync
        const dateMatch = text.match(/(\d{1,2})[\/\-\.](\d{1,2})/);
        if(dateMatch) {
            const now = new Date();
            const year = now.getFullYear();
            const dateStr = `${year}-${dateMatch[2].padStart(2,'0')}-${dateMatch[1].padStart(2,'0')}T08:00`;
            document.getElementById('startT').value = dateStr;
            document.getElementById('endT').value = dateStr;
        }
        render();
    }

    // 4. FIFO Matching Logic
    function fifoMatch() {
        const q = parseInt(document.getElementById('qty').value) || 0;
        if(q <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ!");

        const busyPlates = tourHistory.filter(t => t.status === "Busy").map(t => t.plate);
        let freeCars = fleet.filter(c => !busyPlates.includes(c.plate));

        // Sort by Last Job Completion (FIFO)
        freeCars.sort((a, b) => {
            const timeA = tourHistory.filter(t => t.plate === a.plate).pop()?.timestamp || 0;
            const timeB = tourHistory.filter(t => t.plate === b.plate).pop()?.timestamp || 0;
            return new Date(timeA) - new Date(timeB);
        });

        selectedPlates = freeCars.slice(0, q).map(c => c.plate);
        render();
    }

    // 5. Submit to Google Sheets & WhatsApp
    async function submitTour() {
        const tid = document.getElementById('tourID').value;
        const det = document.getElementById('detail').value;
        const s = document.getElementById('startT').value;
        const e = document.getElementById('endT').value;

        if(!tid || selectedPlates.length === 0) return alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö!");

        const btn = document.getElementById('waBtn');
        btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        btn.disabled = true;

        const selCars = fleet.filter(f => selectedPlates.includes(f.plate));

        try {
            await fetch(API, {
                method: 'POST',
                body: JSON.stringify({
                    action: "SAVE_TOUR",
                    tourName: tid,
                    location: det,
                    start: s,
                    end: e,
                    selectedCars: selCars
                })
            });

            // WA Message Generator
            let msg = `üöõ *‡πÅ‡∏ú‡∏á‡∏à‡∏±‡∏î‡∏£‡∏ñ‡∏ó‡∏±‡∏ß‡∏£‡πå: ${tid}*\nüìç *‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:* ${det}\nüìÖ *‡πÄ‡∏£‡∏¥‡πà‡∏°:* ${s.replace('T',' ')}\nüèÅ *‡∏™‡πà‡∏á:* ${e.replace('T',' ')}\n----------\n`;
            selCars.forEach((c, i) => msg += `${i+1}. ‚úÖ *${c.plate}* (${c.driver})\n`);
            
            window.location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            
            selectedPlates = [];
            syncData();
        } catch (err) { alert("Error: " + err); }
        finally { btn.innerText = "üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏™‡πà‡∏á WhatsApp"; btn.disabled = false; }
    }

    // --- Helper Functions ---
    function toggleSelect(p) {
        const i = selectedPlates.indexOf(p);
        if(i > -1) selectedPlates.splice(i, 1); else selectedPlates.push(p);
        render();
    }

    async function resetCar(plate) {
        if(confirm(`‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏´‡πâ‡∏£‡∏ñ ${plate} ‡∏ß‡πà‡∏≤‡∏á‡∏á‡∏≤‡∏ô?`)) {
            await fetch(API, { method: 'POST', body: JSON.stringify({ action: "RESET_SINGLE", plate: plate }) });
            syncData();
        }
    }

    async function saveCarToSheet() {
        const p = document.getElementById('newP').value;
        const d = document.getElementById('newD').value;
        const ph = document.getElementById('newPh').value;
        if(!p || !d) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö");
        
        await fetch(API, { method: 'POST', body: JSON.stringify({ action: "ADD_CAR", plate: p, driver: d, phone: ph }) });
        document.getElementById('newP').value = ''; document.getElementById('newD').value = '';
        toggleAdmin();
        syncData();
    }

    function getTourColor(id) {
        let hash = 0;
        for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
        return VIBRANT_COLORS[Math.abs(hash) % VIBRANT_COLORS.length];
    }

    function toggleAdmin() {
        const el = document.getElementById('admin');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    window.onload = syncData;
    setInterval(syncData, 10000); // Auto-sync every 10 seconds
</script>
</body>
</html>
