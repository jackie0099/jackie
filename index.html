<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetFlow Pro v10.8 - Full Detail</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --primary: #dc2626; --card: #ffffff; --text-dark: #1e293b; --whatsapp: #25D366; }
        body { font-family: 'Noto Sans Lao', sans-serif; background: var(--bg); color: #f8fafc; margin: 0; padding: 15px; padding-bottom: 150px; }
        .container { max-width: 950px; margin: auto; }
        .sync-info { text-align: center; font-size: 12px; margin-bottom: 10px; color: #94a3b8; }
        .dot { display: inline-block; width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 5px; animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .panel { background: var(--card); padding: 18px; border-radius: 15px; margin-bottom: 15px; color: var(--text-dark); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        textarea, input { width: 100%; padding: 12px; border: 1.5px solid #cbd5e1; border-radius: 10px; margin-bottom: 8px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
        .car-card { background: var(--card); color: var(--text-dark); padding: 15px; border-radius: 12px; border-left: 10px solid #94a3b8; cursor: pointer; transition: 0.3s; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .car-card.selected { border-left-color: #000 !important; transform: scale(1.02); filter: brightness(0.95); }
        .status-badge { font-size: 11px; font-weight: bold; float: right; padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.1); }
        .plate { font-size: 1.4rem; font-weight: 800; color: #000; display: block; margin-top: 5px; }
        .loc-detail { font-size: 11px; color: #ef4444; background: rgba(239, 68, 68, 0.1); padding: 3px 8px; border-radius: 5px; margin-top: 5px; display: block; font-weight: bold; }
        .btn { border: none; padding: 14px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; font-family: inherit; margin-top: 8px; font-size: 16px; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-reset-small { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; font-size: 10px; padding: 2px 8px; border-radius: 5px; float: right; }
        .edit-box { display: none; margin-top: 10px; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        #waBtn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; background: var(--whatsapp); color: white; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.4); text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; margin-bottom: 5px;">üöÄ Fleet Master Pro v10.8</h2>
    <div class="sync-info"><span class="dot"></span> Cloud Sync Active (Auto-Free)</div>

    <div class="panel">
        <textarea id="rawText" rows="4" placeholder="‡∫ß‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫°‡∫ó‡∫ª‡∫ß‡∫ö‡ªà‡∫≠‡∫ô‡∫ô‡∫µ‡ªâ..." oninput="autoParse()"></textarea>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="text" id="tourID" placeholder="‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ó‡∫ª‡∫ß">
            <input type="number" id="carQty" placeholder="‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫•‡∫ª‡∫î (‡∫Ñ‡∫±‡∫ô)">
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><small style="color:gray">‡∫°‡∫∑‡ªâ‡∫Æ‡∫±‡∫ö:</small><input type="datetime-local" id="startTime"></div>
            <div><small style="color:gray">‡∫°‡∫∑‡ªâ‡∫™‡∫ª‡ªà‡∫á:</small><input type="datetime-local" id="endTime"></div>
        </div>
        <input type="text" id="tourDetail" placeholder="üìç ‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫ö‡ªà‡∫≠‡∫ô‡∫Æ‡∫±‡∫ö-‡∫™‡∫ª‡ªà‡∫á (‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫ó‡∫µ‡ªà)">
        <button class="btn btn-main" onclick="autoMatch()">üé≤ ‡∫™‡∫∏‡ªà‡∫°‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î‡∫ó‡∫µ‡ªà‡∫ß‡ªà‡∫≤‡∫á</button>
    </div>

    <div id="fleetDisplay" class="fleet-grid"></div>
    <button id="waBtn" class="btn" onclick="saveAndSend()">üöÄ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å & ‡∫™‡∫ª‡ªà‡∫á WhatsApp</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyc1qHuF2w0BjV1by9lJLvEZm3GZ66kqjkfgbAlwszuDQ6Ry4-8ukhObLY7vgy-WsXe/exec";
    
    let savedFleet = JSON.parse(localStorage.getItem('myFleet')) || [
        { plate: '‡∫ö‡∫Å 3301', driver: '‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö 1', phone: '020 5512301' },
        { plate: '‡∫ö‡∫Å 3302', driver: '‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö 2', phone: '020 5512302' },
        { plate: '‡∫ö‡∫Å 3303', driver: '‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö 3', phone: '020 5512303' },
        { plate: '‡∫ö‡∫Å 3304', driver: '‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö 4', phone: '020 5512304' },
        { plate: '‡∫ö‡∫Å 3305', driver: '‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö 5', phone: '020 5512305' },
        { plate: '‡∫ö‡∫Å 3306', driver: '‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö 6', phone: '020 5512306' },
        { plate: '‡∫ö‡∫Å 3307', driver: '‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö 7', phone: '020 5512307' },
        { plate: '‡∫ö‡∫Å 3308', driver: '‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö 8', phone: '020 5512308' },
        { plate: '‡∫ö‡∫Å 3309', driver: '‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö 9', phone: '020 5512309' },
        { plate: '‡∫ö‡∫Å 3310', driver: '‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö 10', phone: '020 5512310' }
    ];

    let cars = [];
    let selectedPlates = [];

    // ‡∫ü‡∫±‡∫á‡∫ä‡∫±‡ªà‡∫ô‡∫™‡ªâ‡∫≤‡∫á‡∫™‡∫µ‡ªÅ‡∫ç‡∫Å‡∫Å‡∫∏‡ªà‡∫° (‡∫™‡∫µ‡∫î‡∫Ω‡∫ß‡∫Å‡∫±‡∫ô‡∫™‡∫≥‡∫•‡∫±‡∫ö‡∫ó‡∫ª‡∫ß ID ‡∫î‡∫Ω‡∫ß‡∫Å‡∫±‡∫ô)
    function generateColor(str) {
        if (!str) return "#ffffff";
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        // ‡∫™‡ªâ‡∫≤‡∫á‡∫™‡∫µ Pastel ‡ªÉ‡∫´‡ªâ‡ªÅ‡∫ï‡∫Å‡∫ï‡ªà‡∫≤‡∫á‡∫Å‡∫±‡∫ô‡ªÉ‡∫ô‡ªÅ‡∫ï‡ªà‡∫•‡∫∞ ID
        return `hsl(${Math.abs(hash) % 360}, 75%, 94%)`;
    }

    async function fetchCloudData() {
        try {
            const res = await fetch(API_URL);
            const cloudData = await res.json();
            const now = new Date().getTime();
            
            cars = savedFleet.map(f => {
                const cloud = cloudData.find(c => c.plate === f.plate);
                if (cloud && cloud.endTime) {
                    const isBusy = now < new Date(cloud.endTime).getTime();
                    return { 
                        ...f, 
                        isBusy: isBusy, 
                        tourName: isBusy ? cloud.tourName : '', 
                        tourLoc: isBusy ? (cloud.tourLoc || '‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫ó‡∫µ‡ªà') : '',
                        groupColor: isBusy ? generateColor(cloud.tourName) : "#ffffff" 
                    };
                }
                return { ...f, isBusy: false, tourLoc: '', groupColor: "#ffffff" };
            });
            render();
        } catch (e) { 
            cars = savedFleet.map(f => ({ ...f, isBusy: false, tourLoc: '', groupColor: "#ffffff" }));
            render(); 
        }
    }

    async function resetSingleCar(plate) {
        if(!confirm(`‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫µ‡ªÄ‡∫ä‡∫±‡∫î‡∫•‡∫ª‡∫î ${plate} ‡ªÉ‡∫´‡ªâ‡∫´‡∫ß‡ªà‡∫≤‡∫á?`)) return;
        try {
            await fetch(API_URL, { 
                method: 'POST', mode: 'no-cors', 
                body: JSON.stringify({ action: 'RESET_SINGLE', plate: plate }) 
            });
            fetchCloudData();
        } catch (e) { alert("‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î!"); }
    }

    function render() {
        const grid = document.getElementById('fleetDisplay');
        grid.innerHTML = '';
        cars.forEach(car => {
            const isSel = selectedPlates.includes(car.plate);
            const borderL = car.isBusy ? "#ef4444" : (isSel ? "#000" : "#94a3b8");
            
            grid.innerHTML += `
                <div class="car-card ${isSel ? 'selected' : ''}" style="background-color: ${car.groupColor}; border-left-color: ${borderL};" onclick="toggleCar('${car.plate}', ${car.isBusy})">
                    <span class="status-badge" style="background:${car.isBusy ? '#fff' : '#dcfce7'}">${car.isBusy ? 'üî¥ ' + car.tourName : 'üü¢ ‡∫ß‡ªà‡∫≤‡∫á'}</span>
                    <span class="plate">${car.plate}</span>
                    <div style="font-weight:bold; margin-top:5px;">üë§ ${car.driver}</div>
                    <div style="font-size:12px; color:gray;">üìû ${car.phone}</div>
                    
                    ${car.isBusy ? `<span class="loc-detail">üìç ${car.tourLoc}</span>` : ''}

                    <div style="margin-top:10px; display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn" style="width:auto; font-size:10px; padding:2px 8px; background:rgba(0,0,0,0.05); margin:0;" onclick="event.stopPropagation(); toggleEdit('${car.plate}')">‚úèÔ∏è Edit</button>
                        ${car.isBusy ? `<button class="btn-reset-small" onclick="event.stopPropagation(); resetSingleCar('${car.plate}')">üîÑ Reset</button>` : ''}
                    </div>

                    <div id="eb-${car.plate}" class="edit-box" onclick="event.stopPropagation();">
                        <input type="text" id="en-${car.plate}" value="${car.driver}">
                        <input type="text" id="ep-${car.plate}" value="${car.phone}">
                        <button class="btn btn-main" style="padding:5px; font-size:12px;" onclick="saveDriverLocal('${car.plate}')">üíæ Save</button>
                    </div>
                </div>`;
        });
    }

    function toggleEdit(p) { const el = document.getElementById(`eb-${p}`); el.style.display = el.style.display==='block'?'none':'block'; }

    function saveDriverLocal(p) {
        const newName = document.getElementById(`en-${p}`).value;
        const newPhone = document.getElementById(`ep-${p}`).value;
        const carIdx = savedFleet.findIndex(x => x.plate === p);
        savedFleet[carIdx].driver = newName;
        savedFleet[carIdx].phone = newPhone;
        localStorage.setItem('myFleet', JSON.stringify(savedFleet));
        toggleEdit(p);
        fetchCloudData();
    }

    function autoParse() {
        const text = document.getElementById('rawText').value;
        const idM = text.match(/([0-9]{4}[A-Z])/i) || text.match(/(ID|‡∫•‡∫∞‡∫´‡∫±‡∫î):\s*([A-Z0-9]+)/i);
        if(idM) document.getElementById('tourID').value = idM[1] || idM[2];
        const qtyM = text.match(/(\d+)\s*‡∫Ñ‡∫±‡∫ô/);
        if(qtyM) document.getElementById('carQty').value = qtyM[1];
        const dates = text.match(/(\d{1,2}\/\d{1,2})/g);
        if(dates) {
            const y = new Date().getFullYear();
            document.getElementById('startTime').value = `${y}-${dates[0].split('/')[1].padStart(2,'0')}-${dates[0].split('/')[0].padStart(2,'0')}T08:00`;
            document.getElementById('endTime').value = `${y}-${dates[dates.length-1].split('/')[1].padStart(2,'0')}-${dates[dates.length-1].split('/')[0].padStart(2,'0')}T17:00`;
        }
        const lines = text.split('\n').filter(l => l.trim().length > 5);
        if(lines.length > 0) document.getElementById('tourDetail').value = lines[0].trim().substring(0, 60);
    }

    function toggleCar(p, busy) { if(!busy) { const idx = selectedPlates.indexOf(p); if(idx > -1) selectedPlates.splice(idx, 1); else selectedPlates.push(p); render(); } }
    
    function autoMatch() {
        const qty = parseInt(document.getElementById('carQty').value) || 0;
        selectedPlates = cars.filter(c => !c.isBusy).sort(() => 0.5 - Math.random()).slice(0, qty).map(c => c.plate);
        render();
    }

    async function saveAndSend() {
        const tid = document.getElementById('tourID').value;
        const end = document.getElementById('endTime').value;
        const loc = document.getElementById('tourDetail').value;
        if(!tid || selectedPlates.length === 0) return alert("‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ö‡ªç‡ªà‡∫Ñ‡∫ª‡∫ö!");
        
        const selCars = selectedPlates.map(p => cars.find(c => c.plate === p));
        
        fetch(API_URL, { 
            method: 'POST', mode: 'no-cors', 
            body: JSON.stringify({ tourName: tid, endTime: end, tourLoc: loc, selectedCars: selCars }) 
        });

        const msg = `üöõ *‡ªÅ‡∫à‡ªâ‡∫á‡∫ó‡∫ª‡∫ß: ${tid}*\nüìç *‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫ó‡∫µ‡ªà:* ${loc}\n‚åõ *‡∫™‡∫ª‡ªà‡∫á‡∫•‡∫ª‡∫î:* ${end}\n----------\n` + selCars.map((c, i) => `${i+1}. ‚úÖ *${c.plate}* (${c.driver})`).join('\n');
        window.location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
        
        selectedPlates = [];
        setTimeout(fetchCloudData, 1500);
    }

    window.onload = fetchCloudData;
    setInterval(fetchCloudData, 15000);
</script>
</body>
</html>
