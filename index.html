<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetFlow Pro v7.0 - ‡∫•‡∫ß‡∫°‡∫ó‡∫∏‡∫Å‡∫ü‡∫±‡∫á‡∫ä‡∫±‡∫ô</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --primary: #dc2626; --card: #ffffff; --text-dark: #1e293b; --whatsapp: #25D366; }
        body { font-family: 'Noto Sans Lao', sans-serif; background: var(--bg); color: #f8fafc; margin: 0; padding: 15px; padding-bottom: 120px; }
        .container { max-width: 900px; margin: auto; }
        .panel { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 15px; color: var(--text-dark); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        textarea, input { width: 100%; padding: 12px; border: 1.5px solid #cbd5e1; border-radius: 10px; margin-bottom: 8px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        .btn { border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; font-family: inherit; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; width: 100%; }
        .btn-sync { background: #0ea5e9; color: white; width: 100%; margin-bottom: 10px; font-size: 16px; }
        .btn-reset { background: #64748b; color: white; width: 100%; margin-top: 5px; }
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
        .car-card { background: var(--card); color: var(--text-dark); padding: 15px; border-radius: 12px; border-left: 6px solid #94a3b8; cursor: pointer; position: relative; }
        .car-card.selected { border-left-color: var(--primary); background-color: #fff1f2; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(220, 38, 38, 0.2); }
        .status-badge { font-size: 11px; font-weight: bold; float: right; padding: 3px 8px; border-radius: 6px; }
        .busy { color: #991b1b; background: #fee2e2; }
        .free { color: #166534; background: #dcfce7; }
        .plate { font-size: 1.3rem; font-weight: 700; color: #000; display: block; }
        .edit-box { display: none; margin-top: 10px; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        #waBtn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 500px; background: var(--whatsapp); color: white; font-size: 18px; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:9999; flex-direction: column; }
    </style>
</head>
<body>

<div id="loader" class="loading">
    <div style="font-size: 40px;">‚è≥</div>
    <p>‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫õ‡∫∞‡∫°‡∫ß‡∫ô‡∫ú‡∫ª‡∫ô Cloud...</p>
</div>

<div class="container">
    <h2 style="text-align:center; margin-bottom:15px;">üöÄ ‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫î‡∫Ç‡∫ª‡∫ô‡∫™‡∫ª‡ªà‡∫á v7.0</h2>
    
    <button class="btn btn-sync" onclick="fetchCloudData()">üîÑ Sync ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô (‡∫°‡∫∑‡∫ñ‡∫∑ & ‡∫Ñ‡∫≠‡∫° ‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫∑‡∫Å‡∫±‡∫ô)</button>

    <div class="panel">
        <h4 style="margin:0 0 10px 0;">üìã ‡∫ß‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫°‡∫ó‡∫ª‡∫ß</h4>
        <textarea id="rawText" rows="4" placeholder="‡∫ß‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫°‡∫à‡∫≤‡∫Å WhatsApp ‡∫ö‡ªà‡∫≠‡∫ô‡∫ô‡∫µ‡ªâ..." oninput="autoParse()"></textarea>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label style="font-size:12px;">‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ó‡∫ª‡∫ß:</label><input type="text" id="tourID"></div>
            <div><label style="font-size:12px;">‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫•‡∫ª‡∫î:</label><input type="number" id="carQty"></div>
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label style="font-size:12px;">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡∫Æ‡∫±‡∫ö:</label><input type="datetime-local" id="startTime"></div>
            <div><label style="font-size:12px;">‡∫ß‡∫±‡∫ô‡∫ó‡∫µ‡∫™‡∫ª‡ªà‡∫á:</label><input type="datetime-local" id="endTime"></div>
        </div>

        <label style="font-size:12px;">‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫ö‡ªà‡∫≠‡∫ô‡∫Æ‡∫±‡∫ö-‡∫™‡∫ª‡ªà‡∫á:</label>
        <input type="text" id="tourDetail">
        
        <button class="btn btn-main" onclick="autoMatch()">üé≤ ‡∫™‡∫∏‡ªà‡∫°‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î‡∫ó‡∫µ‡ªà‡∫ß‡ªà‡∫≤‡∫á</button>
        <button class="btn btn-reset" onclick="resetAll()">üîÑ ‡∫•‡∫µ‡ªÄ‡∫ä‡∫±‡∫î‡∫•‡∫ª‡∫î‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫±‡∫ô‡ªÉ‡∫´‡ªâ‡∫ß‡ªà‡∫≤‡∫á (Manual Reset)</button>
    </div>

    <div id="fleetDisplay" class="fleet-grid"></div>
    
    <button id="waBtn" class="btn" onclick="saveAndSend()">üöÄ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞ & ‡∫™‡∫ª‡ªà‡∫á WhatsApp</button>
</div>

<script>
    // URL ‡∫Ç‡∫≠‡∫á Google Apps Script ‡∫ó‡∫µ‡ªà‡∫ó‡ªà‡∫≤‡∫ô Deploy
    const API_URL = "https://script.google.com/macros/s/AKfycbxjLwcmVBOGc2_VPYkiKrdKCQhTu9AbVc1vvWmH7b_MR-159N0s6YXS5ifMcDDL587W/exec";

    let cars = [];
    let selectedPlates = [];

    // 1. ‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫à‡∫≤‡∫Å Cloud
    async function fetchCloudData() {
        showLoader(true);
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            const now = new Date().getTime();
            
            // ‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö Auto-Reset ‡∫ï‡∫≤‡∫°‡ªÄ‡∫ß‡∫•‡∫≤ EndTime
            cars = data.map(c => ({
                ...c,
                isBusy: c.endTime && now < new Date(c.endTime).getTime()
            }));
            
            render();
        } catch (e) { alert("Error: ‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà Cloud ‡ªÑ‡∫î‡ªâ!"); }
        showLoader(false);
    }

    // 2. ‡ªÅ‡∫ç‡∫Å‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫°‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î
    function autoParse() {
        const text = document.getElementById('rawText').value;
        const lines = text.split('\n').map(l => l.trim()).filter(l => l !== "");
        
        // ‡∫ä‡∫≠‡∫Å‡∫´‡∫≤ ID
        const idMatch = text.match(/(ID|‡∫•‡∫∞‡∫´‡∫±‡∫î):\s*(\w+)/i);
        document.getElementById('tourID').value = idMatch ? idMatch[2] : (lines[0] || "");

        // ‡∫ä‡∫≠‡∫Å‡∫´‡∫≤‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫•‡∫ª‡∫î
        const qtyMatch = text.match(/(\d+)\s*‡∫Ñ‡∫±‡∫ô/);
        if(qtyMatch) document.getElementById('carQty').value = qtyMatch[1];

        // ‡∫ä‡∫≠‡∫Å‡∫´‡∫≤‡∫ß‡∫±‡∫ô‡∫ó‡∫µ
        const dates = text.match(/(\d{1,2}\/\d{1,2})/g);
        if(dates) {
            const y = new Date().getFullYear();
            const d1 = dates[0].split('/');
            document.getElementById('startTime').value = `${y}-${d1[1].padStart(2,'0')}-${d1[0].padStart(2,'0')}T08:00`;
            if(dates[1]) {
                const d2 = dates[1].split('/');
                document.getElementById('endTime').value = `${y}-${d2[1].padStart(2,'0')}-${d2[0].padStart(2,'0')}T17:00`;
            }
        }
        
        // ‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î (‡ªÄ‡∫≠‡∫ª‡∫≤‡ªÅ‡∫ñ‡∫ß‡∫ó‡∫µ‡ªà‡∫ö‡ªç‡ªà‡ªÅ‡∫°‡ªà‡∫ô ID)
        document.getElementById('tourDetail').value = lines.find(l => !l.includes(document.getElementById('tourID').value)) || "";
    }

    // 3. ‡∫™‡∫∞‡ªÅ‡∫î‡∫á‡∫ú‡∫ª‡∫ô‡∫•‡∫ª‡∫î
    function render() {
        const grid = document.getElementById('fleetDisplay');
        grid.innerHTML = '';
        cars.forEach(car => {
            const isSel = selectedPlates.includes(car.plate);
            grid.innerHTML += `
                <div class="car-card ${isSel ? 'selected' : ''}" 
                     style="${car.isBusy ? 'border-left-color:red; background:#fee2e2;' : ''}"
                     onclick="toggleCar('${car.plate}', ${car.isBusy})">
                    <span class="status-badge ${car.isBusy ? 'busy' : 'free'}">
                        ${car.isBusy ? 'üî¥ ‡∫ï‡∫¥‡∫î‡∫ß‡∫Ω‡∫Å: ' + car.tourName : 'üü¢ ‡∫ß‡ªà‡∫≤‡∫á'}
                    </span>
                    <span class="plate">${car.plate}</span>
                    <div style="font-size:14px; font-weight:bold;">üë§ ${car.driver}</div>
                    <div style="font-size:12px; color:#64748b;">üìû ${car.phone}</div>
                    
                    <div style="margin-top:10px; border-top:1px solid #eee; pt:5px;">
                        <button class="btn" style="padding:4px 8px; font-size:11px; background:#f1f5f9;" onclick="event.stopPropagation(); showEdit('${car.plate}')">‚úèÔ∏è ‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç</button>
                    </div>

                    <div id="edit-${car.plate}" class="edit-box" onclick="event.stopPropagation();">
                        <input type="text" id="new-d-${car.plate}" value="${car.driver}" placeholder="‡∫ä‡∫∑‡ªà‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö">
                        <input type="text" id="new-p-${car.plate}" value="${car.phone}" placeholder="‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó">
                        <button class="btn btn-main" style="padding:5px;" onclick="saveCarEdit('${car.plate}')">‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å</button>
                    </div>
                </div>`;
        });
    }

    function toggleCar(plate, isBusy) {
        if(isBusy) return;
        const idx = selectedPlates.indexOf(plate);
        if(idx > -1) selectedPlates.splice(idx, 1);
        else selectedPlates.push(plate);
        render();
    }

    function autoMatch() {
        const qty = parseInt(document.getElementById('carQty').value) || 0;
        const available = cars.filter(c => !c.isBusy);
        selectedPlates = available.sort(() => 0.5 - Math.random()).slice(0, qty).map(c => c.plate);
        render();
    }

    // 4. ‡∫™‡∫ª‡ªà‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô ‡ªÅ‡∫•‡∫∞ WhatsApp
    async function saveAndSend() {
        const tid = document.getElementById('tourID').value;
        const end = document.getElementById('endTime').value;
        if(!tid || selectedPlates.length === 0) return alert("‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö ID ‡ªÅ‡∫•‡∫∞ ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î!");

        showLoader(true);
        const selectedCars = selectedPlates.map(p => cars.find(c => c.plate === p));
        
        try {
            // ‡∫™‡∫ª‡ªà‡∫á‡∫•‡∫ª‡∫á Cloud (Google Sheets)
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ tourName: tid, endTime: end, selectedCars: selectedCars })
            });

            // ‡∫™‡ªâ‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫° WhatsApp
            const msg = `üöõ *‡ªÅ‡∫à‡ªâ‡∫á‡∫à‡∫±‡∫î‡∫•‡∫ª‡∫î: ${tid}*\nüìç *‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î:* ${document.getElementById('tourDetail').value}\n‚åõ *‡∫™‡∫ª‡ªà‡∫á‡∫•‡∫ª‡∫î:* ${end || '‡∫ï‡∫≤‡∫°‡ªÅ‡∫ú‡∫ô'}\n----------\n` + 
                        selectedCars.map((c, i) => `${i+1}. ‚úÖ *${c.plate}* (${c.driver})`).join('\n');
            
            window.location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            
            selectedPlates = [];
            setTimeout(fetchCloudData, 2000);
        } catch (e) { alert("‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ö‡ªç‡ªà‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î!"); }
        showLoader(false);
    }

    // ‡∫ü‡∫±‡∫á‡∫ä‡∫±‡∫ô‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡ªÄ‡∫ï‡∫µ‡∫°
    function showEdit(plate) { const el = document.getElementById(`edit-${plate}`); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
    async function saveCarEdit(plate) {
        const d = document.getElementById(`new-d-${plate}`).value;
        const p = document.getElementById(`new-p-${plate}`).value;
        // ‡ªÉ‡∫ô v7.0 ‡ªÄ‡∫Æ‡∫ª‡∫≤‡∫à‡∫∞‡∫™‡∫ª‡ªà‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡ªÑ‡∫õ Cloud (‡∫ñ‡ªâ‡∫≤ API ‡∫Æ‡∫≠‡∫á‡∫Æ‡∫±‡∫ö) ‡∫´‡∫º‡∫∑ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ä‡∫ª‡ªà‡∫ß‡∫Ñ‡∫≤‡∫ß
        alert("‡∫•‡∫∞‡∫ö‡∫ª‡∫ö‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫Å‡∫≤‡∫ô‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç...");
        showEdit(plate);
    }
    async function resetAll() {
        if(confirm("‡∫•‡∫µ‡ªÄ‡∫ä‡∫±‡∫î‡∫•‡∫ª‡∫î‡∫ó‡∫∏‡∫Å‡∫Ñ‡∫±‡∫ô‡ªÉ‡∫´‡ªâ‡∫ß‡ªà‡∫≤‡∫á?")) {
            await fetch(API_URL + "?action=reset", { method: 'POST', mode: 'no-cors' });
            setTimeout(fetchCloudData, 1000);
        }
    }
    function showLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }

    window.onload = fetchCloudData;
</script>
</body>
</html>
