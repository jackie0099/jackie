<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fleet Master v24.4</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e11d48; --accent: #0ea5e9; --bg: #0f172a; --card: #ffffff; }
        body { font-family: 'Noto Sans Lao', sans-serif; background: var(--bg); color: #fff; margin: 0; padding-bottom: 120px; }
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }
        .panel { background: var(--card); color: #1e293b; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        input, textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .car-card { background: white; color: #1e293b; padding: 15px; border-radius: 12px; border-left: 8px solid #cbd5e1; cursor: pointer; transition: 0.3s; position: relative; }
        .car-card.selected { border-left-width: 15px; border-left-color: var(--accent); transform: scale(1.03); background: #f0f9ff; }
        .car-card.busy { opacity: 0.7; background: #f1f5f9; cursor: not-allowed; }
        .plate { font-size: 1.4rem; font-weight: 800; display: block; color: #0f172a; }
        .badge { position: absolute; top: 10px; right: 10px; font-size: 10px; padding: 2px 8px; border-radius: 10px; color: white; font-weight: bold; }
        #waBtn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: #22c55e; color: white; border: none; padding: 18px; border-radius: 50px; font-weight: 700; font-size: 1.1rem; box-shadow: 0 10px 25px rgba(34,197,94,0.4); cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">üöõ Fleet Master <span style="color:var(--accent)">v24.4</span></h2>
        <button onclick="syncData()" style="background:none; border:1px solid #fff; color:#fff; padding:5px 10px; border-radius:8px; cursor:pointer;">üîÑ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </header>

    <div class="panel">
        <label style="font-size:12px; color:gray;">üìã ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° WhatsApp</label>
        <textarea id="rawWA" rows="3" placeholder="‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..." oninput="parseWA()"></textarea>
        <div class="grid-inputs" style="margin-top:10px;">
            <input type="text" id="tourID" placeholder="ID ‡∏ó‡∏±‡∏ß‡∏£‡πå" oninput="render()">
            <input type="number" id="qty" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ">
        </div>
        <div class="grid-inputs">
            <input type="datetime-local" id="start">
            <input type="datetime-local" id="end">
        </div>
        <input type="text" id="loc" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô" style="margin-top:5px;">
        <button onclick="fifoMatch()" style="margin-top:10px; width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">‚öñÔ∏è ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏ñ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (FIFO)</button>
    </div>
    <div id="fleetGrid" class="fleet-grid"></div>
</div>
<button id="waBtn" onclick="saveAndSend()">üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å & ‡∏™‡πà‡∏á WhatsApp</button>

<script>
    const API = "https://script.google.com/macros/s/AKfycbzblfVRA7Siy5iQZUgzidJP5pH-hjcqjS5wfXL7dXZ_olZWG46VU232zF_3xTx5pxBf/exec";
    let fleet = []; let tourHistory = []; let selectedPlates = [];

    async function syncData() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            fleet = data.fleet; tourHistory = data.activeStatus;
            render();
        } catch(e) { console.error("Sync Error"); }
    }

    function render() {
        const grid = document.getElementById('fleetGrid'); grid.innerHTML = '';
        fleet.forEach(car => {
            const lastJob = tourHistory.filter(t => t.plate == car.plate).pop();
            const isBusy = lastJob && lastJob.status === "Busy";
            const isSelected = selectedPlates.includes(car.plate);
            
            const card = document.createElement('div');
            card.className = `car-card ${isBusy ? 'busy' : ''} ${isSelected ? 'selected' : ''}`;
            card.innerHTML = `
                <span class="badge" style="background:${isBusy ? '#ef4444' : (isSelected ? '#0ea5e9' : '#22c55e')}">${isBusy ? lastJob.tourName : (isSelected ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏á‡∏á‡∏≤‡∏ô' : '‡∏ß‡πà‡∏≤‡∏á')}</span>
                <span class="plate">${car.plate}</span>
                <small>üë§ ${car.driver}</small><br>
                ${isBusy ? `<button onclick="event.stopPropagation(); resetCar('${car.plate}')" style="margin-top:8px; width:100%; border:none; background:#fee2e2; color:#b91c1c; padding:6px; border-radius:5px; cursor:pointer; font-size:10px; font-weight:bold;">üîÑ Reset ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á</button>` : ''}
            `;
            if(!isBusy) card.onclick = () => {
                if(selectedPlates.includes(car.plate)) selectedPlates = selectedPlates.filter(p => p !== car.plate);
                else selectedPlates.push(car.plate);
                render();
            };
            grid.appendChild(card);
        });
    }

    function parseWA() {
        const t = document.getElementById('rawWA').value;
        const idM = t.match(/([0-9]{4}[A-Z])/i); if(idM) document.getElementById('tourID').value = idM[0];
        const qM = t.match(/(\d+)\s*(‡∫Ñ‡∫±‡∫ô|‡∏Ñ‡∏±‡∏ô)/); if(qM) document.getElementById('qty').value = qM[1];
        render();
    }

    function fifoMatch() {
        const q = parseInt(document.getElementById('qty').value) || 0;
        const busyP = tourHistory.filter(t => t.status === "Busy").map(t => t.plate);
        let free = fleet.filter(c => !busyP.includes(c.plate));
        free.sort((a,b) => {
            const tA = tourHistory.filter(t => t.plate == a.plate).pop()?.timestamp || 0;
            const tB = tourHistory.filter(t => t.plate == b.plate).pop()?.timestamp || 0;
            return new Date(tA) - new Date(tB);
        });
        selectedPlates = free.slice(0, q).map(c => c.plate);
        render();
    }

    async function saveAndSend() {
        const tid = document.getElementById('tourID').value;
        if(!tid || !selectedPlates.length) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ!");
        const btn = document.getElementById('waBtn'); btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; btn.disabled = true;

        try {
            const selCars = fleet.filter(f => selectedPlates.includes(f.plate));
            await fetch(API, { 
                method: 'POST', 
                mode: 'no-cors', // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS ‡πÉ‡∏ô Apps Script
                body: JSON.stringify({
                    action: "SAVE_TOUR", tourName: tid, location: document.getElementById('loc').value,
                    start: document.getElementById('start').value, end: document.getElementById('end').value,
                    selectedCars: selCars
                })
            });
            
            let msg = `üöõ *‡πÅ‡∏ú‡∏á‡∏à‡∏±‡∏î‡∏£‡∏ñ‡∏ó‡∏±‡∏ß‡∏£‡πå: ${tid}*\nüìç *‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:* ${document.getElementById('loc').value}\n----------\n`;
            selCars.forEach((c, i) => msg += `${i+1}. ‚úÖ *${c.plate}* (${c.driver})\n`);
            window.location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            
            selectedPlates = []; setTimeout(syncData, 2000);
        } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"); }
        finally { btn.innerText = "üöÄ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å & ‡∫™‡∫ª‡ªà‡∫á WhatsApp"; btn.disabled = false; }
    }

    async function resetCar(p) {
        if(confirm(`‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏ñ ${p} ‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á?`)) {
            await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "RESET_SINGLE", plate: p }) });
            setTimeout(syncData, 1500);
        }
    }

    window.onload = syncData; setInterval(syncData, 30000);
</script>
</body>
</html>
