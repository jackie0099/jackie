<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fleet Master Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e11d48; --accent: #0ea5e9; --bg: #0f172a; }
        body { font-family: 'Noto Sans Lao', sans-serif; background: var(--bg); color: white; margin: 0; padding: 15px; }
        .panel { background: white; color: #1e293b; padding: 20px; border-radius: 16px; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 10px; font-family: inherit; }
        .btn { border: none; padding: 14px; border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; font-family: inherit; }
        .btn-main { background: var(--primary); color: white; }
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .car-card { background: white; color: #1e293b; padding: 15px; border-radius: 16px; border-left: 10px solid #cbd5e1; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="loader">‚öôÔ∏è ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÄ‡∫ä‡∫∑‡ªà‡∫≠‡∫°‡∫ï‡ªç‡ªà Cloud...</div>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <b>üöõ Fleet Master Cloud</b>
    <button onclick="syncData()" style="background:none; color:var(--accent); border:none; cursor:pointer;">üîÑ ‡∫£‡∫µ‡ªÄ‡∫ü‡∫£‡∫™</button>
</div>

<div class="panel">
    <h3 style="margin-top:0; color:var(--bg)">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫•‡∫ª‡∫î‡ªÉ‡ªù‡ªà</h3>
    <input type="text" id="newP" placeholder="‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡∫•‡∫ª‡∫î">
    <input type="text" id="newD" placeholder="‡∫ä‡∫∑‡ªà‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö">
    <input type="text" id="newPh" placeholder="‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó">
    <button class="btn btn-main" onclick="addCar()">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫ª‡∫á Google Sheet</button>
</div>

<div id="fleet" class="fleet-grid"></div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwXITyvYjarBEuUUmnu4uOh53aB6wUA-9UeryHvc45ARcHcykQu7oCjxdWfYdqExGqq/exec";

    async function syncData() {
        document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            render(data.fleet, data.tours);
        } catch (e) { 
            alert("‚ùå ‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫î‡∫∂‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÑ‡∫î‡ªâ: ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫Å‡∫ß‡∫î‡∫™‡∫≠‡∫ö Deployment URL"); 
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }

    function render(fleet, tours) {
        const container = document.getElementById('fleet');
        container.innerHTML = fleet.length === 0 ? '<p style="text-align:center;">--- ‡∫ö‡ªç‡ªà‡∫°‡∫µ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫•‡∫ª‡∫î ---</p>' : '';
        fleet.forEach(car => {
            const active = tours.find(t => t.plate === car.plate && t.status === "Active");
            const card = document.createElement('div');
            card.className = 'car-card';
            card.style.borderLeftColor = active ? '#e11d48' : '#22c55e';
            card.innerHTML = `
                <div style="font-size:1.2rem; font-weight:bold;">${car.plate}</div>
                <div>üë§ ${car.driver}</div>
                <div style="font-size:0.8rem; color:gray;">${active ? 'üî¥ ‡∫ö‡ªç‡ªà‡∫´‡∫ß‡ªà‡∫≤‡∫á: ' + active.tourName : 'üü¢ ‡∫´‡∫ß‡ªà‡∫≤‡∫á'}</div>
            `;
            container.appendChild(card);
        });
    }

    async function addCar() {
        const p = document.getElementById('newP').value.trim();
        const d = document.getElementById('newD').value.trim();
        const ph = document.getElementById('newPh').value.trim();
        
        if(!p || !d) return alert("‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö!");

        document.getElementById('loader').style.display = 'flex';
        
        try {
            // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö Text ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS ‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏≤‡∏á‡∏£‡∏∏‡πà‡∏ô
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: "ADD_CAR", plate: p, driver: d, phone: ph })
            });

            // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ no-cors ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            setTimeout(() => {
                document.getElementById('newP').value = '';
                document.getElementById('newD').value = '';
                document.getElementById('newPh').value = '';
                syncData();
            }, 2000);

        } catch (e) {
            alert("‚ùå ‡ªÄ‡∫Å‡∫µ‡∫î‡∫Ç‡ªç‡ªâ‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î: " + e.message);
            document.getElementById('loader').style.display = 'none';
        }
    }

    window.onload = syncData;
</script>
</body>
</html>
