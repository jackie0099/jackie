<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fleet Master v24.6 - Full Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e11d48; --accent: #0ea5e9; --bg: #0f172a; --card: #ffffff; --text: #1e293b; }
        body { font-family: 'Noto Sans Lao', sans-serif; background: var(--bg); color: #fff; margin: 0; padding-bottom: 120px; }
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }
        .panel { background: var(--card); color: var(--text); padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        input, textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .car-card { background: white; color: var(--text); padding: 15px; border-radius: 12px; border-left: 8px solid #cbd5e1; position: relative; transition: 0.3s; cursor: pointer; }
        .car-card.selected { border-left-width: 15px; border-left-color: var(--accent); background: #f0f9ff; transform: translateY(-3px); }
        .car-card.busy { opacity: 0.7; background: #f1f5f9; cursor: not-allowed; }
        .plate { font-size: 1.4rem; font-weight: 800; display: block; color: #0f172a; }
        .badge { position: absolute; top: 10px; right: 10px; font-size: 10px; padding: 2px 8px; border-radius: 10px; color: white; font-weight: bold; }
        .btn-action { width: 100%; border: none; padding: 6px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-reset { background: #dcfce7; color: #166534; }
        .btn-delete { background: #fee2e2; color: #b91c1c; }
        #waBtn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: #22c55e; color: white; border: none; padding: 18px; border-radius: 50px; font-weight: 700; font-size: 1.1rem; box-shadow: 0 10px 25px rgba(34,197,94,0.4); cursor: pointer; z-index: 1000; }
        .admin-btn { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">üöõ Fleet Master <span style="color:var(--accent)">v24.6</span></h2>
        <button onclick="toggleAdmin()" class="admin-btn">‚öôÔ∏è ‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫î</button>
    </header>

    <div id="adminPanel" class="panel" style="display:none; border: 2px dashed var(--accent);">
        <h3 style="margin-top:0;">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫•‡∫ª‡∫î‡ªÉ‡ªù‡πà</h3>
        <div class="grid-inputs">
            <input type="text" id="addP" placeholder="‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡∫•‡∫ª‡∫î">
            <input type="text" id="addD" placeholder="‡∫ä‡∫∑‡ªà‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö">
            <input type="text" id="addPh" placeholder="‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó">
        </div>
        <button onclick="manageCar('ADD_CAR')" style="width:100%; padding:12px; background:#0f172a; color:white; border-radius:10px; border:none; cursor:pointer; font-weight:bold;">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫ª‡∫î‡∫•‡∫ª‡∫á Sheet</button>
    </div>

    <div class="panel">
        <textarea id="rawWA" rows="2" placeholder="‡∫ß‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫° WhatsApp ‡∫ö‡ªà‡∫≠‡∫ô‡∫ô‡∫µ‡ªâ..." oninput="parseWA()"></textarea>
        <div class="grid-inputs" style="margin-top:10px;">
            <input type="text" id="tid" placeholder="ID ‡∫ó‡∫ª‡∫ß">
            <input type="number" id="qty" placeholder="‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫•‡∫ª‡∫î">
        </div>
        <div class="grid-inputs">
            <input type="datetime-local" id="start">
            <input type="datetime-local" id="end">
        </div>
        <input type="text" id="loc" placeholder="‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î/‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫Ñ‡∫ª‡∫ô" style="margin-top:5px;">
        <button onclick="fifoMatch()" style="margin-top:10px; width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">‚öñÔ∏è ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î (FIFO)</button>
    </div>

    <div id="fleetGrid" class="fleet-grid"></div>
</div>

<button id="waBtn" onclick="saveAndSend()">üöÄ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å & ‡∫™‡∫ª‡ªà‡∫á WhatsApp</button>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxe6LqSFNa6NlHX5ydLsocbOYqEoa7CIr9J_8z8I-CQLOovNXEXu-8PvXPue1kmYLej/exec";
    const PALETTE = ["#e1f5fe", "#f3e5f5", "#e8f5e9", "#fff3e0", "#efebe9", "#fce4ec", "#e0f2f1", "#f9fbe7"];

    let fleet = []; // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ‡∏à‡∏≤‡∏Å Sheet Data
    let cloudData = []; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Sheet Tours
    let selectedPlates = [];
    let isAdminMode = false;

    // üîÑ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
    async function syncData() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            fleet = data.fleet || []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏ñ
            cloudData = data.activeStatus || []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô
            render();
        } catch (e) { console.log("Sync Error:", e); render(); }
    }

    // üé® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏•‡∏∞ Sheet
    function getTourColor(id) {
        if(!id || id === "‡∫´‡∫ß‡ªà‡∫≤‡∫á") return "#cbd5e1";
        let hash = 0;
        for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
        return PALETTE[Math.abs(hash) % PALETTE.length];
    }

    // ‚öñÔ∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏£‡∏ñ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (FIFO) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    function autoMatch() {
        const q = parseInt(document.getElementById('qty').value) || 0;
        if (q <= 0) return alert("‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÉ‡∫™‡ªà‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫•‡∫ª‡∫î!");

        // ‡∏´‡∏≤‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô "Busy"
        const busyPlates = new Set(cloudData.filter(d => d.status === "Busy").map(d => d.plate));
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
        let freeCars = fleet.filter(c => !busyPlates.has(c.plate));

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (FIFO)
        freeCars.sort((a, b) => {
            const lastA = cloudData.filter(d => d.plate === a.plate).pop();
            const lastB = cloudData.filter(d => d.plate === b.plate).pop();
            const timeA = lastA ? new Date(lastA.timestamp) : new Date(0);
            const timeB = lastB ? new Date(lastB.timestamp) : new Date(0);
            return timeA - timeB;
        });

        selectedPlates = freeCars.slice(0, q).map(c => c.plate);
        render();
    }

    function render() {
        const container = document.getElementById('fleet');
        const tid = document.getElementById('tourID').value || "SEL";
        container.innerHTML = '';

        fleet.forEach(car => {
            const busyJob = cloudData.find(c => c.plate === car.plate && c.status === "Busy");
            const isSelected = selectedPlates.includes(car.plate);
            
            // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ó‡∏±‡∏ß‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
            let tourColor = busyJob ? getTourColor(busyJob.tourName) : (isSelected ? getTourColor(tid) : "#cbd5e1");
            
            const card = document.createElement('div');
            card.className = `car-card ${isSelected ? 'selected' : ''} ${busyJob ? 'busy' : ''}`;
            card.style.borderLeftColor = tourColor;
            if(isSelected || busyJob) card.style.backgroundColor = tourColor + "44"; 

            card.innerHTML = `
                <div class="badge" style="background:${tourColor}">${busyJob ? busyJob.tourName : (isSelected ? '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß' : '‡∫´‡∫ß‡ªà‡∫≤‡∫á')}</div>
                <div class="plate-number">${car.plate}</div>
                <div style="font-weight:700;">üë§ ${car.driver}</div>
                <div style="font-size:14px;"><a href="tel:${car.phone}" style="color:var(--accent); font-weight:bold;">üìû ${car.phone || '---'}</a></div>
                <div style="margin-top:10px;">
                    ${busyJob ? `<button class="btn" style="padding:6px; font-size:11px; background:var(--primary); color:white; width:100%;" onclick="event.stopPropagation(); forceReset('${car.plate}')">üîÑ Reset ‡∫´‡∫ß‡ªà‡∫≤‡∫á</button>` : ''}
                </div>
            `;
            if(!busyJob && !isAdminMode) card.onclick = () => {
                const i = selectedPlates.indexOf(car.plate);
                if(i > -1) selectedPlates.splice(i, 1); else selectedPlates.push(car.plate);
                render();
            };
            container.appendChild(card);
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (saveAndSend, parseWhatsApp) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô v25.3
    window.onload = syncData;
    setInterval(syncData, 30000);
</script>
