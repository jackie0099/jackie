<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fleet Master Cloud Pro v2.5</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e11d48; --accent: #0ea5e9; --bg: #0f172a; }
        body { font-family: 'Noto Sans Lao', sans-serif; background: var(--bg); color: white; margin: 0; padding: 15px; }
        .panel { background: white; color: #1e293b; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 10px 15px rgba(0,0,0,0.3); }
        input, textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; margin-bottom: 10px; font-family: inherit; color: #1e293b; }
        .btn { border: none; padding: 14px; border-radius: 10px; font-weight: 700; cursor: pointer; width: 100%; font-family: inherit; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-admin { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .car-card { background: white; color: #1e293b; padding: 15px; border-radius: 16px; border-left: 10px solid #cbd5e1; position: relative; cursor: pointer; }
        .car-card.selected { border-left-color: var(--accent); background: #f0f9ff; transform: translateY(-2px); }
        .car-card.busy { opacity: 0.6; background: #f8fafc; cursor: default; }
        .plate { font-size: 1.5rem; font-weight: 800; color: #0f172a; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<div id="loader">üîÑ ‡∫Å‡ªç‡∫≤‡∫•‡∫±‡∫á‡∫õ‡∫∞‡∫°‡∫ß‡∫ô‡∫ú‡∫ª‡∫ô...</div>

<header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <div style="font-size:1.3rem; font-weight:700;">üöõ Fleet Master <span style="color:var(--accent)">Cloud</span></div>
    <button class="btn btn-admin" style="width:auto; padding:8px 15px;" onclick="toggleAdmin()">‚öôÔ∏è ‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫î</button>
</header>

<div id="admin" style="display:none;" class="panel">
    <h3 style="margin-top:0;">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫•‡∫ª‡∫î‡ªÉ‡ªù‡ªà‡∫•‡∫ª‡∫á Cloud</h3>
    <input type="text" id="newP" placeholder="‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡∫•‡∫ª‡∫î (‡∫Å‡∫Å 1111)">
    <input type="text" id="newD" placeholder="‡∫ä‡∫∑‡ªà‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö">
    <input type="text" id="newPh" placeholder="‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó">
    <button class="btn btn-main" onclick="addCar()">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫ª‡∫á Google Sheet</button>
</div>

<div class="panel">
    <textarea id="rawText" rows="2" placeholder="‡∫ß‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫° WhatsApp ‡∫ö‡ªà‡∫≠‡∫ô‡∫ô‡∫µ‡ªâ..." oninput="parseWhatsApp()"></textarea>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <input type="text" id="tourID" placeholder="‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ó‡∫ª‡∫ß" oninput="render()">
        <input type="number" id="qty" placeholder="‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫•‡∫ª‡∫î">
    </div>
    <button class="btn" style="background:#334155; color:white;" onclick="autoMatch()">‚öñÔ∏è ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î‡∫ï‡∫≤‡∫°‡∫Ñ‡∫¥‡∫ß (FIFO)</button>
</div>

<div id="fleet" class="fleet-grid"></div>

<button id="waBtn" class="btn" style="background:#22c55e; color:white; position:fixed; bottom:20px; left:5%; width:90%; box-shadow:0 10px 20px rgba(0,0,0,0.3);" onclick="saveAndSend()">üöÄ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å & ‡∫™‡∫ª‡ªà‡∫á WhatsApp</button>

<script>
    // URL ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const API_URL = "https://script.google.com/macros/s/AKfycbwXITyvYjarBEuUUmnu4uOh53aB6wUA-9UeryHvc45ARcHcykQu7oCjxdWfYdqExGqq/exec";
    
    let fleet = [];
    let cloudTours = [];
    let selectedPlates = [];

    async function syncData() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            fleet = data.fleet;
            cloudTours = data.tours;
            render();
        } catch (e) { console.log("Sync Error"); }
    }

    function render() {
        const container = document.getElementById('fleet');
        container.innerHTML = '';
        const tid = document.getElementById('tourID').value;

        fleet.forEach(car => {
            const active = cloudTours.find(t => t.plate === car.plate && t.status === "Active");
            const isSelected = selectedPlates.includes(car.plate);
            
            const card = document.createElement('div');
            card.className = `car-card ${isSelected ? 'selected' : ''} ${active ? 'busy' : ''}`;
            card.innerHTML = `
                <div style="font-size:10px; position:absolute; top:10px; right:10px; padding:3px 8px; border-radius:10px; background:#f1f5f9; font-weight:bold;">
                    ${active ? '‡∫ß‡∫Ω‡∫Å: ' + active.tourName : (isSelected ? '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß' : '‡∫´‡∫ß‡ªà‡∫≤‡∫á')}
                </div>
                <div class="plate">${car.plate}</div>
                <div style="font-weight:700; color:#475569;">üë§ ${car.driver}</div>
                ${active ? `<button onclick="event.stopPropagation(); forceReset('${car.plate}')" style="background:none; border:none; color:#e11d48; cursor:pointer; font-size:12px; margin-top:10px; padding:0; font-weight:bold;">üîÑ ‡∫Ñ‡∫∑‡∫ô‡∫Ñ‡∫¥‡∫ß (Reset)</button>` : ''}
            `;
            if(!active) card.onclick = () => toggleSelect(car.plate);
            container.appendChild(card);
        });
    }

    function toggleSelect(p) {
        const i = selectedPlates.indexOf(p);
        if(i > -1) selectedPlates.splice(i, 1); else selectedPlates.push(p);
        render();
    }

    async function addCar() {
        const p = document.getElementById('newP').value.trim();
        const d = document.getElementById('newD').value.trim();
        const ph = document.getElementById('newPh').value.trim();
        if(!p || !d) return alert("‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö!");

        toggleLoader(true);
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "ADD_CAR", plate: p, driver: d, phone: ph }) });
        
        setTimeout(async () => {
            await syncData();
            toggleLoader(false);
            toggleAdmin();
            document.getElementById('newP').value=''; document.getElementById('newD').value=''; document.getElementById('newPh').value='';
        }, 2500);
    }

    async function forceReset(p) {
        if(!confirm("‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡ªÉ‡∫´‡ªâ‡∫•‡∫ª‡∫î‡∏Ñ‡∫±‡∫ô‡∏ô‡∏µ‡πâ‡∫´‡∫ß‡ªà‡∫≤‡∫á?")) return;
        toggleLoader(true);
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "RESET_SINGLE", plate: p }) });
        setTimeout(async () => { await syncData(); toggleLoader(false); }, 2000);
    }

    async function saveAndSend() {
        const tid = document.getElementById('tourID').value;
        if(!tid || !selectedPlates.length) return alert("‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î ‡ªÅ‡∫•‡∫∞ ‡ªÉ‡∫™‡ªà‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ó‡∫ª‡∫ß!");

        toggleLoader(true);
        const cars = selectedPlates.map(p => fleet.find(f => f.plate === p));
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "SAVE_TOUR", tourName: tid, selectedCars: cars }) });

        const msg = `üöõ *‡ªÅ‡∫à‡ªâ‡∫á‡∫à‡∫±‡∫î‡∫•‡∫ª‡∫î: ${tid}*\n` + cars.map((c, i) => `${i+1}. ‚úÖ *${c.plate}* (${c.driver})`).join('\n');
        window.location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
        
        setTimeout(() => { selectedPlates = []; syncData(); toggleLoader(false); }, 2000);
    }

    function autoMatch() {
        const q = parseInt(document.getElementById('qty').value) || 0;
        const busy = cloudTours.filter(t => t.status === "Active").map(t => t.plate);
        const free = fleet.filter(c => !busy.includes(c.plate));
        selectedPlates = free.slice(0, q).map(c => c.plate);
        render();
    }

    function toggleAdmin() { const el = document.getElementById('admin'); el.style.display = el.style.display==='none'?'block':'none'; }
    function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
    
    function parseWhatsApp() {
        const text = document.getElementById('rawText').value;
        const idM = text.match(/([0-9]{4}[A-Z])/i); if(idM) document.getElementById('tourID').value = idM[0];
        const qM = text.match(/(\d+)\s*‡∫Ñ‡∫±‡∫ô/); if(qM) document.getElementById('qty').value = qM[1];
        render();
    }

    window.onload = syncData;
    setInterval(syncData, 30000); // Sync ‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
</script>
</body>
</html>
