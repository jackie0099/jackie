<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fleet Master Cloud - Pro v2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #e11d48;
            --primary-dark: #be123c;
            --secondary: #334155;
            --accent: #0ea5e9;
            --bg-dark: #0f172a;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Noto Sans Lao', sans-serif;
            background: var(--bg-dark);
            background-image: radial-gradient(circle at 0% 0%, rgba(225,29,72,0.1) 0%, transparent 40%);
            color: #fff; margin: 0; min-height: 100vh;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 15px; padding-bottom: 100px; }
        
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px); border-radius: var(--radius);
            border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px;
        }

        .panel {
            background: var(--card-bg); color: var(--text-main); padding: 20px;
            border-radius: var(--radius); margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
        }

        .panel-title { font-weight: 700; margin-bottom: 15px; color: var(--secondary); font-size: 1.1rem; }

        input, textarea {
            width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px;
            font-family: inherit; margin-bottom: 10px; background: #f8fafc; color: var(--text-main);
        }

        .btn {
            border: none; padding: 12px; border-radius: 12px; font-weight: 700;
            cursor: pointer; font-family: inherit; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-main { background: var(--primary); color: white; width: 100%; }
        .btn-ghost { background: #f1f5f9; color: var(--secondary); font-size: 0.8rem; }

        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }

        .car-card {
            background: var(--card-bg); color: var(--text-main); padding: 15px;
            border-radius: var(--radius); border-left: 10px solid #cbd5e1;
            transition: 0.3s; position: relative; cursor: pointer;
        }
        .car-card.selected { border-left-color: var(--accent) !important; background: #f0f9ff; transform: translateY(-2px); }
        .car-card.busy { opacity: 0.8; background: #f8fafc; cursor: default; }

        .plate-number { font-size: 1.5rem; font-weight: 800; color: var(--bg-dark); }
        
        #waBtn {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: #22c55e; color: white;
            z-index: 1000; box-shadow: 0 10px 25px rgba(34,197,94,0.4);
        }

        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7);
            display:none; justify-content:center; align-items:center; z-index:9999;
        }
    </style>
</head>
<body>

<div id="loader">üîÑ ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡∫õ‡∫∞‡∫°‡∫ß‡∫ô‡∫ú‡∫ª‡∫ô...</div>

<div class="container">
    <header>
        <div>üöõ <b>Fleet Master</b> <span style="color:var(--accent)">Cloud v2.0</span></div>
        <button class="btn btn-ghost" onclick="toggleAdmin()">‚öôÔ∏è ‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫î</button>
    </header>

    <div id="admin" style="display:none;" class="panel">
        <div class="panel-title">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫•‡∫ª‡∫î‡ªÉ‡ªù‡ªà‡∫•‡∫ª‡∫á‡∫ñ‡∫≤‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</div>
        <input type="text" id="newP" placeholder="‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡∫•‡∫ª‡∫î (‡∫Å‡∫Å 1111)">
        <input type="text" id="newD" placeholder="‡∫ä‡∫∑‡ªà‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö">
        <input type="text" id="newPh" placeholder="‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó">
        <button class="btn btn-main" onclick="addCar()">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫ª‡∫á Cloud</button>
    </div>

    <div class="panel">
        <div class="panel-title">üìã ‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫Å‡∫≤‡∫ô‡∫à‡∫≠‡∫á</div>
        <textarea id="rawText" rows="3" placeholder="‡∫ß‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫° WhatsApp ‡∫ö‡ªà‡∫≠‡∫ô‡∫ô‡∫µ‡ªâ..." oninput="parseWhatsApp()"></textarea>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="text" id="tourID" placeholder="‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ó‡∫ª‡∫ß" oninput="render()">
            <input type="number" id="qty" placeholder="‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫•‡∫ª‡∫î">
        </div>
        <input type="text" id="tourDetail" placeholder="‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫ó‡∫µ‡ªà">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
            <div><small style="color:var(--text-muted)">‡ªÄ‡∫ß‡∫•‡∫≤‡∫Æ‡∫±‡∫ö:</small><input type="datetime-local" id="startTime"></div>
            <div><small style="color:var(--text-muted)">‡ªÄ‡∫ß‡∫•‡∫≤‡∫™‡∫ª‡ªà‡∫á:</small><input type="datetime-local" id="endTime"></div>
        </div>

        <button class="btn btn-main" style="background:var(--secondary); margin-top:10px;" onclick="autoMatch()">‚öñÔ∏è ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î‡∫ï‡∫≤‡∫°‡∫Ñ‡∫¥‡∫ß (FIFO)</button>
    </div>

    <div id="fleet" class="fleet-grid"></div>

    <button id="waBtn" class="btn" onclick="saveAndSend()">üöÄ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å & ‡∫™‡∫ª‡ªà‡∫á WhatsApp</button>
</div>

<script>
    // --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ---
    const API_URL = "https://script.google.com/macros/s/AKfycbxX5mIPEJ4oHcIvuumuRKLa1Ia714G6j3nqTS65Ac9cEXwLQjI5Xo4zuTRHkHOiNXIk/exec";
    
    let fleet = [];
    let cloudTours = [];
    let selectedPlates = [];
    const COLORS = ["#2563eb", "#d97706", "#7c3aed", "#db2777", "#059669", "#dc2626", "#4f46e5", "#ea580c"];

    async function syncData() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            fleet = data.fleet;
            cloudTours = data.tours;
            render();
        } catch (e) { console.error("Sync failed", e); }
    }

    function getTourColor(id) {
        if(!id) return "#cbd5e1";
        let hash = 0;
        for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
        return COLORS[Math.abs(hash) % COLORS.length];
    }

    function render() {
        const container = document.getElementById('fleet');
        const tid = document.getElementById('tourID').value;
        container.innerHTML = '';

        fleet.forEach(car => {
            const activeTour = cloudTours.find(t => t.plate === car.plate && t.status === "Active");
            const isSelected = selectedPlates.includes(car.plate);
            const history = cloudTours.filter(t => t.plate === car.plate);
            const lastWork = history.length > 0 ? new Date(Math.max(...history.map(h => new Date(h.timestamp)))) : null;

            let cardColor = activeTour ? getTourColor(activeTour.tourName) : (isSelected ? getTourColor(tid || "SEL") : "#cbd5e1");

            const card = document.createElement('div');
            card.className = `car-card ${isSelected ? 'selected' : ''} ${activeTour ? 'busy' : ''}`;
            card.style.borderLeftColor = cardColor;
            card.innerHTML = `
                <div style="position:absolute; top:10px; right:10px; font-size:10px; padding:3px 8px; border-radius:10px; background:${cardColor}; color:white; font-weight:700;">
                    ${activeTour ? activeTour.tourName : (isSelected ? '‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß' : '‡∫´‡∫ß‡ªà‡∫≤‡∫á')}
                </div>
                <div class="plate-number">${car.plate}</div>
                <div style="font-weight:600; color:var(--secondary)">üë§ ${car.driver}</div>
                <div style="font-size:12px; color:var(--text-muted)">
                    ${activeTour ? `üìç ${activeTour.tourLoc}` : `üí§ ‡∫û‡∫±‡∫Å‡∫ï‡∫±‡ªâ‡∫á‡ªÅ‡∫ï‡ªà: ${lastWork ? lastWork.toLocaleTimeString('lo-LA') : '‡∫û‡ªâ‡∫≠‡∫°‡∫ß‡∫Ω‡∫Å'}`}
                </div>
                <div style="margin-top:10px; display:flex; gap:5px;">
                    ${activeTour ? `<button class="btn btn-ghost" style="background:#fee2e2; color:#ef4444; padding:5px 10px; height:auto;" onclick="event.stopPropagation(); forceReset('${car.plate}')">üîÑ Reset</button>` : ''}
                </div>
            `;
            
            if(!activeTour) {
                card.onclick = () => {
                    const idx = selectedPlates.indexOf(car.plate);
                    if(idx > -1) selectedPlates.splice(idx, 1);
                    else selectedPlates.push(car.plate);
                    render();
                };
            }
            container.appendChild(card);
        });
    }

    function parseWhatsApp() {
        const text = document.getElementById('rawText').value;
        const idM = text.match(/([0-9]{4}[A-Z])/i); if(idM) document.getElementById('tourID').value = idM[0];
        const qM = text.match(/(\d+)\s*‡∫Ñ‡∫±‡∫ô/); if(qM) document.getElementById('qty').value = qM[1];
        render();
    }

    async function addCar() {
        const p = document.getElementById('newP').value.trim();
        const d = document.getElementById('newD').value.trim();
        const ph = document.getElementById('newPh').value.trim();
        if(!p || !d) return alert("‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö!");

        showLoading(true);
        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: "ADD_CAR", plate: p, driver: d, phone: ph })
            });
            alert("‚úÖ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫ª‡∫î‡∫•‡∫ª‡∫á Cloud ‡ªÅ‡∫•‡ªâ‡∫ß");
            document.getElementById('newP').value = ''; document.getElementById('newD').value = '';
            setTimeout(syncData, 1500);
        } catch(e) { alert("Error: " + e); }
        showLoading(false);
        toggleAdmin();
    }

    async function forceReset(plate) {
        if(!confirm(`‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô Reset ‡∫•‡∫ª‡∫î ${plate} ‡ªÉ‡∫´‡ªâ‡∫´‡∫ß‡ªà‡∫≤‡∫á?`)) return;
        showLoading(true);
        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: "RESET_SINGLE", plate: plate })
            });
            setTimeout(syncData, 1500);
        } catch(e) { alert("Error: " + e); }
        showLoading(false);
    }

    async function saveAndSend() {
        const tid = document.getElementById('tourID').value;
        if(!tid || selectedPlates.length === 0) return alert("‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î ‡ªÅ‡∫•‡∫∞ ‡ªÉ‡∫™‡ªà‡∫•‡∫∞‡∫´‡∫±‡∫î‡∫ó‡∫ª‡∫ß!");

        showLoading(true);
        const selectedCarsData = selectedPlates.map(p => fleet.find(f => f.plate === p));
        
        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    action: "SAVE_TOUR",
                    tourName: tid,
                    tourLoc: document.getElementById('tourDetail').value,
                    startTime: document.getElementById('startTime').value,
                    endTime: document.getElementById('endTime').value,
                    selectedCars: selectedCarsData
                })
            });

            const msg = `üöõ *‡ªÅ‡∫à‡ªâ‡∫á‡∫à‡∫±‡∫î‡∫•‡∫ª‡∫î‡∫ó‡∫ª‡∫ß: ${tid}*\nüìç *‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î:* ${document.getElementById('tourDetail').value}\n----------\n` + 
                        selectedCarsData.map((c, i) => `${i+1}. ‚úÖ *${c.plate}* (${c.driver})`).join('\n');
            
            window.location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            selectedPlates = [];
            setTimeout(syncData, 2000);
        } catch(e) { alert("Error: " + e); }
        showLoading(false);
    }

    function autoMatch() {
        const q = parseInt(document.getElementById('qty').value) || 0;
        const busyPlates = cloudTours.filter(t => t.status === "Active").map(t => t.plate);
        const freeCars = fleet.filter(c => !busyPlates.includes(c.plate));
        
        freeCars.sort((a,b) => {
            const lastA = cloudTours.filter(t => t.plate === a.plate).pop()?.timestamp || 0;
            const lastB = cloudTours.filter(t => t.plate === b.plate).pop()?.timestamp || 0;
            return new Date(lastA) - new Date(lastB);
        });

        selectedPlates = freeCars.slice(0, q).map(c => c.plate);
        render();
    }

    function toggleAdmin() {
        const el = document.getElementById('admin');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function showLoading(show) {
        document.getElementById('loader').style.display = show ? 'flex' : 'none';
    }

    window.onload = syncData;
    setInterval(syncData, 30000); 
</script>
</body>
</html>
