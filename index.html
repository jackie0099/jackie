<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fleet Master v24.6 - Full Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e11d48; --accent: #0ea5e9; --bg: #0f172a; --card: #ffffff; --text: #1e293b; }
        body { font-family: 'Noto Sans Lao', sans-serif; background: var(--bg); color: #fff; margin: 0; padding-bottom: 120px; }
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }
        
        .panel { background: var(--card); color: var(--text); padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        input, textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        
        .fleet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .car-card { background: white; color: var(--text); padding: 15px; border-radius: 12px; border-left: 8px solid #cbd5e1; position: relative; transition: 0.3s; cursor: pointer; }
        .car-card.selected { border-left-width: 15px; border-left-color: var(--accent); background: #f0f9ff; transform: translateY(-3px); }
        .car-card.busy { opacity: 0.7; background: #f1f5f9; cursor: not-allowed; }
        
        .plate { font-size: 1.4rem; font-weight: 800; display: block; color: #0f172a; }
        .badge { position: absolute; top: 10px; right: 10px; font-size: 10px; padding: 2px 8px; border-radius: 10px; color: white; font-weight: bold; }
        
        .btn-action { width: 100%; border: none; padding: 6px; border-radius: 6px; font-size: 11px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-reset { background: #dcfce7; color: #166534; }
        .btn-delete { background: #fee2e2; color: #b91c1c; }
        
        #waBtn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: #22c55e; color: white; border: none; padding: 18px; border-radius: 50px; font-weight: 700; font-size: 1.1rem; box-shadow: 0 10px 25px rgba(34,197,94,0.4); cursor: pointer; z-index: 1000; }
        .admin-btn { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">üöõ Fleet Master <span style="color:var(--accent)">v24.6</span></h2>
        <button onclick="toggleAdmin()" class="admin-btn">‚öôÔ∏è ‡∫à‡∫±‡∫î‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫î</button>
    </header>

    <div id="adminPanel" class="panel" style="display:none; border: 2px dashed var(--accent);">
        <h3 style="margin-top:0;">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡∫•‡∫ª‡∫î‡ªÉ‡ªù‡ªà</h3>
        <div class="grid-inputs">
            <input type="text" id="addP" placeholder="‡∫ó‡∫∞‡∫ö‡∫Ω‡∫ô‡∫•‡∫ª‡∫î">
            <input type="text" id="addD" placeholder="‡∫ä‡∫∑‡ªà‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö">
            <input type="text" id="addPh" placeholder="‡ªÄ‡∫ö‡∫µ‡ªÇ‡∫ó">
        </div>
        <button onclick="manageCar('ADD_CAR')" style="width:100%; padding:12px; background:#0f172a; color:white; border-radius:10px; border:none; cursor:pointer; font-weight:bold;">üíæ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫•‡∫ª‡∫î‡∫•‡∫ª‡∫á Sheet</button>
    </div>

    <div class="panel">
        <textarea id="rawWA" rows="2" placeholder="‡∫ß‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫Ñ‡∫ß‡∫≤‡∫° WhatsApp ‡∫ö‡ªà‡∫≠‡∫ô‡∫ô‡∫µ‡ªâ..." oninput="parseWA()"></textarea>
        <div class="grid-inputs" style="margin-top:10px;">
            <input type="text" id="tid" placeholder="ID ‡∫ó‡∫ª‡∫ß">
            <input type="number" id="qty" placeholder="‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫•‡∫ª‡∫î">
        </div>
        <div class="grid-inputs">
            <input type="datetime-local" id="start">
            <input type="datetime-local" id="end">
        </div>
        <input type="text" id="loc" placeholder="‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î/‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫Ñ‡∫ª‡∫ô" style="margin-top:5px;">
        <button onclick="fifoMatch()" style="margin-top:10px; width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">‚öñÔ∏è ‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î‡∫≠‡∫±‡∫î‡∫ï‡∫∞‡ªÇ‡∫ô‡∫°‡∫±‡∫î (FIFO)</button>
    </div>

    <div id="fleetGrid" class="fleet-grid"></div>
</div>

<button id="waBtn" onclick="saveAndSend()">üöÄ ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å & ‡∫™‡∫ª‡ªà‡∫á WhatsApp</button>

<script>
    const API = "https://script.google.com/macros/s/AKfycbxO6J7Zp5lpK7Y6y0jYWvYrKP5Ygx_s9BXDYaLWIgbCrQzcsDKeIftldrYzX2tj3evF/exec";
    let fleet = []; let history = []; let selectedPlates = [];
    let isAdminMode = false;

    async function sync() {
        try {
            const res = await fetch(API);
            const data = await res.json();
            fleet = data.fleet; history = data.activeStatus;
            render();
        } catch(e) { console.error("Sync Error"); }
    }

    function render() {
        const grid = document.getElementById('fleetGrid'); grid.innerHTML = '';
        fleet.forEach(car => {
            const lastJob = history.filter(t => t.plate == car.plate).pop();
            const isBusy = lastJob && lastJob.status === "Busy";
            const isSelected = selectedPlates.includes(car.plate);
            
            const card = document.createElement('div');
            card.className = `car-card ${isBusy ? 'busy' : ''} ${isSelected ? 'selected' : ''}`;
            card.innerHTML = `
                <span class="badge" style="background:${isBusy ? '#ef4444' : (isSelected ? '#0ea5e9' : '#22c55e')}">${isBusy ? lastJob.tourName : '‡∫´‡∫ß‡ªà‡∫≤‡∫á'}</span>
                <span class="plate">${car.plate}</span>
                <small>üë§ ${car.driver}</small>
                ${isBusy ? `<button onclick="event.stopPropagation(); manageCar('RESET_SINGLE', '${car.plate}')" class="btn-action btn-reset">üîÑ Reset ‡∫´‡∫ß‡ªà‡∫≤‡∫á</button>` : ''}
                ${isAdminMode ? `<button onclick="event.stopPropagation(); manageCar('DELETE_CAR', '${car.plate}')" class="btn-action btn-delete">‚ùå ‡∫•‡∫ª‡∫ö‡∫•‡∫ª‡∫î‡∫≠‡∫≠‡∫Å</button>` : ''}
            `;
            if(!isBusy && !isAdminMode) card.onclick = () => toggle(car.plate);
            grid.appendChild(card);
        });
    }

    async function manageCar(action, plate = '') {
        let payload = { action: action };
        if(action === 'ADD_CAR') {
            payload.plate = document.getElementById('addP').value;
            payload.driver = document.getElementById('addD').value;
            payload.phone = document.getElementById('addPh').value;
            if(!payload.plate || !payload.driver) return alert("‡∫õ‡ªâ‡∫≠‡∫ô‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡ªÉ‡∫´‡ªâ‡∫Ñ‡∫ª‡∫ö!");
        } else {
            payload.plate = plate;
            if(action === 'DELETE_CAR' && !confirm(`‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫•‡∫ª‡∫ö‡∫•‡∫ª‡∫î ${plate}?`)) return;
        }

        try {
            await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            if(action === 'ADD_CAR') { document.getElementById('addP').value=''; document.getElementById('addD').value=''; document.getElementById('addPh').value=''; }
            setTimeout(sync, 1500);
        } catch(e) { alert("Error!"); }
    }

    function toggle(p) {
        if(selectedPlates.includes(p)) selectedPlates = selectedPlates.filter(i => i !== p);
        else selectedPlates.push(p);
        render();
    }

    function parseWA() {
        const t = document.getElementById('rawWA').value;
        const idM = t.match(/([0-9]{4}[A-Z])/i); if(idM) document.getElementById('tid').value = idM[0];
        const qM = t.match(/(\d+)\s*(‡∫Ñ‡∫±‡∫ô|‡∏Ñ‡∏±‡∏ô)/); if(qM) document.getElementById('qty').value = qM[1];
        render();
    }

    function fifoMatch() {
        const q = parseInt(document.getElementById('qty').value) || 0;
        const busyP = history.filter(t => t.status === "Busy").map(t => t.plate);
        let free = fleet.filter(c => !busyP.includes(c.plate));
        free.sort((a,b) => {
            const tA = history.filter(t => t.plate == a.plate).pop()?.timestamp || 0;
            const tB = history.filter(t => t.plate == b.plate).pop()?.timestamp || 0;
            return new Date(tA) - new Date(tB);
        });
        selectedPlates = free.slice(0, q).map(c => c.plate);
        render();
    }

    async function saveAndSend() {
        const tid = document.getElementById('tid').value;
        if(!tid || !selectedPlates.length) return alert("‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡∫•‡∫ª‡∫î‡∫Å‡ªà‡∫≠‡∫ô!");
        const selCars = fleet.filter(f => selectedPlates.includes(f.plate));
        await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({
            action: "SAVE_TOUR", tourName: tid, location: document.getElementById('loc').value,
            start: document.getElementById('start').value, end: document.getElementById('end').value,
            selectedCars: selCars
        })});
        let msg = `üöõ *‡ªÅ‡∫à‡ªâ‡∫á‡∫•‡∫ª‡∫î‡∫ó‡∫ª‡∫ß: ${tid}*\nüìç *‡∫•‡∫≤‡∫ç‡∫•‡∫∞‡∫≠‡∫Ω‡∫î:* ${document.getElementById('loc').value}\n----------\n`;
        selCars.forEach((c, i) => msg += `${i+1}. ‚úÖ *${c.plate}* (${c.driver})\n`);
        window.location.href = `https://wa.me/?text=${encodeURIComponent(msg)}`;
        selectedPlates = []; setTimeout(sync, 1500);
    }

    function toggleAdmin() {
        isAdminMode = !isAdminMode;
        document.getElementById('adminPanel').style.display = isAdminMode ? 'block' : 'none';
        render();
    }

    window.onload = sync; setInterval(sync, 30000);
</script>
</body>
</html>
